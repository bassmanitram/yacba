MYDIR="$(dirname "$(realpath "${BASH_SOURCE[0]}")")" 
#
# A Bash script to help call yacba
#

#
# Load the virtual environment (assumed to be in .venv)
#
if [[ -f "$MYDIR/.venv/bin/activate" ]]; then
	echo "Activated venv from $MYDIR/.venv/bin/activate" >&2
	source "$MYDIR/.venv/bin/activate"
elif [[ -f "$MYDIR/../.venv/bin/activate" ]]; then
	echo "Activated venv from $MYDIR/../.venv/bin/activate" >&2
	source "$MYDIR/../.venv/bin/activate"
fi

## Logging is through Loguru - by default don't display anything except errors
export YACBA_LOG_LEVEL=${YACBA_LOG_LEVEL:-ERROR}

##
## LiteLLM has a bug whereby in certain circumstances it doesn't
## clean up its async HTTP resources. That emits warnings that are
## quite tough to get rid of. This is how we hack that here.
##
export PYTHONWARNINGS=ignore
FILTER_PATTERN="^Unclosed (client session|connector)|^client_session:|^connections:|^connector:"

##
## 
##
python3 -Wi "$MYDIR/yacba.py" "${@}" 2> >(grep --line-buffered -vE "$FILTER_PATTERN" >&2)
